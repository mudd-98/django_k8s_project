apiVersion: apps/v1
kind: Deployment
metadata:
  name: django-deployment
spec:
  replicas: 2   # Django 앱 Pod를 2개 실행 (고가용성 확보)
  selector:
    matchLabels:
      app: django-web
  template:
    metadata:
      labels:
        app: django-web   # Pod 라벨
    spec:
      volumes:
        - name: static-files
          emptyDir: {}
        - name: nginx-config-volume
          configMap:
            name: django-nginx-config
      
      containers:
        - name: django-web-container
          image: mudd0/django_k8s_project:v1.34
          imagePullPolicy: Always
          
          command: ["/bin/sh", "-c"]
          args:
            - "python manage.py collectstatic --noinput && gunicorn config.wsgi:application --bind 0.0.0.0:8000"

          # 환경변수 주입
          envFrom:
            - configMapRef:
                name: django-config   # 07-web-configmap.yaml
            - secretRef:
                name: django-secret   # 06-web-secret.yaml
          env:
            - name: POSTGRES_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: postgres-secret   # 01-db-secret.yaml
                  key: postgres-password
          volumeMounts:
            - name: static-files
              mountPath: /app/staticfiles # (여기에 CSS를 모음)
          
        # --- (!!!) 컨테이너 2 (신규): Nginx (사이드카) ---
        - name: nginx-sidecar
          image: nginx:1.25-alpine # 경량 Nginx 이미지 사용
          ports:
            # (!!!) Nginx가 Pod의 '정문'인 80번 포트를 담당
            - containerPort: 80
          volumeMounts:
            # 1. (읽기 전용) CSS 공유 공간을 마운트
            - name: static-files
              mountPath: /app/staticfiles # (여기서 CSS를 읽어감)
              readOnly: true
            # 2. (읽기 전용) Nginx 설정 파일을 마운트
            - name: nginx-config-volume
              # (Step 1에서 만든 ConfigMap의 'nginx.conf' 키를 가져옴)
              mountPath: /etc/nginx/conf.d/nginx.conf
              subPath: nginx.conf
              readOnly: true
